# CATF Core Library Audit (2026-01-15)

Scope: audit-only against GAP-01..GAP-07 checklist provided in the conversation.

This audit is based on the current repository state in `src/` (Go module `xdao.co/catf`).
No protocol redesign is proposed here; this document only identifies where each gap is already satisfied and where concrete implementation work remains.

---

## Quick Index

- GAP-01 — CATF Canonicalization Enforcement
- GAP-02 — Explicit Trust Policy Verdicts
- GAP-03 — CROF as First-Class Evidence
- GAP-04 — Naming Resolution Has No Special Privilege
- GAP-05 — Global Strict Compliance Mode
- GAP-06 — Adversarial & Negative Test Coverage
- GAP-07 — Core Library API Surface Stabilization

---

## GAP-01 — CATF Canonicalization Enforcement

### Status: **Mostly satisfied** (one notable API-surface concern)

**Canonicalization choke point**
- Canonicalization function exists: `catf.CanonicalizeCATF` in `src/catf/canonicalize.go`.
- Parsing enforces canonical bytes by *re-render + byte compare*: `catf.Parse` in `src/catf/catf.go`.

**Unavoidable canonical bytes for identity operations**
- CID derivation requires canonical bytes:
  - `(*catf.CATF).CID()` re-parses `c.raw` to ensure canonical identity before hashing (`src/catf/catf.go`).
- Signature verification requires canonical bytes:
  - `(*catf.CATF).Verify()` re-parses `c.raw` before interpreting CRYPTO fields (`src/catf/crypto.go`).

**No alternate serialization bypass (core)**
- `catf.Render(Document)` always emits canonical ordering (sorted keys, fixed section order, fixed spacing, LF) (`src/catf/render.go`).
- `catf.NormalizeCATF` is a thin alias to `CanonicalizeCATF` and rejects non-canonical input (no “auto-fix”) (`src/catf/normalize.go`).

**Tests present**
- Deterministic render under shuffled map insertion order: `TestRender_IsDeterministicAcrossMapInsertionOrder` (`src/catf/canonicalization_enforcement_test.go`).
- Reject non-canonical inputs (CRLF, double-space, trailing newline): `TestCanonicalizeCATF_RejectsNonCanonicalInput` (`src/catf/canonicalization_enforcement_test.go`).
- Vector-based canonical/CID checks: `src/catf/conformance_vectors_test.go`.

**Open concern (API-surface)**
- The package exports generic signing helpers (`catf.SignEd25519SHA256`, `catf.SignDilithium3`, `catf.GenerateDilithium3Keypair`) that accept arbitrary byte slices. While protocol verification/CID paths remain canonicalized, the existence of these helpers in the protocol package complicates GAP-07 API tiering and “bypass impossibility” messaging.

---

## GAP-02 — Explicit Trust Policy Verdicts

### Status: **Satisfied**

**Verdict objects exist and are always produced**
- Resolver outputs include `[]Verdict`, `[]Exclusion`, and `[]PolicyVerdict`:
  - `resolver.Resolution` (`src/resolver/resolver.go`)
  - `resolver.NameResolution` (`src/resolver/name.go`)
- Every input attestation produces a verdict (including invalid/unparseable): both `Resolve` and `ResolveName` append a `Verdict` per input; invalid inputs get stable `InputHash` (`sha256:<hex>`) when no CATF CID exists.

**No silent exclusion**
- Invalid CATF: verdict status `Invalid`, plus exclusion with `InputHash` (`src/resolver/resolver.go`, `src/resolver/name.go`).
- Untrusted CATF: verdict status `Excluded`, plus exclusion reason (“Issuer not trusted”).
- Revoked CATF: verdict status `Revoked` and `RevokedBy` list surfaced deterministically.

**Deterministic ordering & stable reasons**
- Verdict sorting is explicit (`verdictLessV2`), reasons are uniqued and sorted (`appendUniqueSorted`) before final ordering (`src/resolver/verdict_evidence.go`, plus call sites in resolver).
- Policy verdicts are computed deterministically and sorted (`evaluatePolicyRules` in `src/resolver/verdict_evidence.go`).

**Verdicts surface into CROF**
- `crof.Render` renders:
  - `RESULT` policy verdict materialization lines
  - `VERDICTS` section containing per-attestation evidence
  - `EXCLUSIONS` section containing rejected/invalid evidence
  (`src/crof/crof.go`).

---

## GAP-03 — CROF as First-Class Evidence

### Status: **Satisfied**

**Canonical serialization & canonicalization enforcement**
- Canonical CROF renderer: `crof.Render` (`src/crof/crof.go`).
- Canonicalization choke point (reject-only, no rewriting): `crof.CanonicalizeCROF` (`src/crof/canonicalize.go`).
- Canonicalization enforcement tests exist (`src/crof/canonicalization_enforcement_test.go`).

**CID-addressable**
- `crof.CID` requires canonical CROF bytes (calls `CanonicalizeCROF`) (`src/crof/cid.go`).
- `crof.RenderWithCID` provides bytes + CID (`src/crof/cid.go`).
- First-class wrapper: `crof.Document` with `NewDocumentFromBytes` + `RenderDocument` (`src/crof/document.go`).

**Optional signing & verification**
- Render supports optional signing (`RenderOptions{ResolverKey, PrivateKey}`) (`src/crof/crof.go`).
- Verification helper exists: `crof.VerifySignature` (`src/crof/verify.go`).

**Supersession support**
- Supersession field extraction: `SupersedesCROFCID` (`src/crof/supersession.go`).
- Supersession validity enforcement: `ValidateSupersession` (`src/crof/supersession.go`).
- Adversarial tests for non-canonical supersession inputs exist (`src/crof/supersession_adversarial_test.go`).

**Library safety (fixed)**
- `crof.Render` no longer panics on signing failure; callers that require signing should use `crof.RenderSigned` (error-returning).

---

## GAP-04 — Naming Resolution Has No Special Privilege

### Status: **Mostly satisfied**

**Names are attestations; naming uses trust pipeline**
- Name resolution consumes CATF attestations + TPDL policy and applies the same parse/validate/verify/trust pipeline as the subject resolver (`ResolveName` in `src/resolver/name.go`).
- Name forks are preserved explicitly as `StateForked` with `NameFork` objects and a stable `Bindings` list of head binding CIDs.

**Name hijack attempts handled explicitly**
- Test covers untrusted attacker binding being excluded and not selected: `TestResolveName_UntrustedBindingIsExcludedAndNotSelected` (`src/resolver/name_test.go`).

**Potential remaining audit item**
- Confirm that CROF rendering for name-resolution outputs is either intentionally out-of-scope or provided via a separate evidence object (currently CROF is for `resolver.Resolution`, not `NameResolution`). If name-resolution outputs must also be serialized as durable evidence, that is not yet represented as CROF in this codebase.

---

## GAP-05 — Global Strict Compliance Mode

### Status: **Mostly satisfied**

**Single compliance mode type exists**
- `compliance.ComplianceMode {Permissive, Strict}` exists (`src/compliance/compliance.go`).

**Resolver + naming strict behavior**
- `resolver.ResolveWithOptions` / `ResolveNameWithOptions` accept `resolver.Options{Mode: compliance.Strict}` (`src/resolver/with_options.go`).
- Convenience entrypoints exist: `ResolveStrict`, `ResolveNameStrict` (`src/resolver/strict.go`).
- Strict mode rejects non-resolved outcomes and exclusions.

**CROF strict behavior**
- `crof.RenderWithCompliance` rejects forks/exclusions/non-resolved and disallows `Resolved-At` in strict mode (`src/crof/crof.go`).
- In strict mode, `RenderWithCompliance` requires explicit `Resolver-ID` (no defaulting).

**TPDL strict behavior (fixed)**
- Strict-mode parsing entrypoints exist: `tpdl.ParseWithCompliance(..., compliance.Strict)` and `tpdl.ParseStrict` (`src/tpdl/tpdl.go`).
- In strict mode, every `Require:` block must explicitly include `Quorum:` (no implicit quorum defaults).

**Remaining strict-mode question (policy semantics)**
- `tpdl.Parse` remains permissive and continues to default `Require.Quorum` to `1` when omitted; strict behavior is enforced only when the strict entrypoints are used.

---

## GAP-06 — Adversarial & Negative Test Coverage

### Status: **Mostly satisfied** (needs a full checklist crosswalk)

Examples already present:
- Determinism against input shuffling (resolver): `TestDeterminism_Resolve_ShuffledInputs` (`src/resolver/determinism_test.go`).
- Determinism against input shuffling (CROF bytes): `TestDeterminism_CROF_ByteIdentical_ShuffledInputs` (`src/crof/determinism_test.go`).
- CROF supersession adversarial canonicalization: `src/crof/supersession_adversarial_test.go`.
- CROF byte/structure malformations (BOM/invalid UTF-8, missing pre/postamble, unexpected content, missing/out-of-order sections, unsorted META, missing required META keys, missing section terminator blank line, malformed RESULT/PATHS/FORKS/EXCLUSIONS/VERDICTS records): `src/crof/canonicalize_test.go`.
- CROF CRYPTO malformation handling (incomplete CRYPTO, duplicated Signature): `src/crof/verify_test.go`.
- Name hijack exclusion test: `src/resolver/name_test.go`.
- TPDL negative coverage (unknown Require fields, invalid quorum, strict quorum enforcement across multiple Require blocks): `src/tpdl/tpdl_test.go`.

Remaining audit work needed (test-by-test mapping):
- Explicit test for “conflicting supersession” (multiple competing supersession heads) in resolver or CROF, and asserting stable fork output.
- Explicit malformed CROF tests beyond CRLF/BOM/trailing whitespace (e.g., missing required sections, unsorted lines) if not already covered by `validateCanonicalCROF` tests.

---

## GAP-07 — Core Library API Surface Stabilization

### Status: **Mostly satisfied**

**Documentation exists**
- `STABILITY.md` defines Stable vs Experimental vs Internal tiers and a SemVer policy.

**Internal packages isolated**
- `src/internal/...` exists and is clearly intended for non-library use.

**Key deltas (fixed)**
- CROF signing is now safe for embedding (no panics) and `RenderSigned` is documented as the error-returning signing API.
- `STABILITY.md` now explicitly lists key exported model/option types so the documented surface matches the Go-export surface more closely.

**Strict-mode assurance (tests)**
- Resolver strict mode now enforces strict TPDL parsing, and this is pinned with an explicit negative test (policies missing an explicit `Quorum:` are rejected in strict mode).

---

## Determinism & Non-Negotiables (cross-check)

- No network APIs detected in `src/` (no `net/http`, gRPC, etc.).
- No wall-clock usage detected in core packages (no `time.Now()`); CROF allows caller-supplied `ResolvedAt`.
- CLI (`src/cmd/xdao-catf`) uses randomness (`crypto/rand`) for convenience, but this is not part of the core library behavior.

---

## Recommended Next Step (implementation phase, after audit approval)

Proceed to minimal fixes in this order:
1) Close remaining negative/adversarial tests identified above (e.g., malformed CROF structural cases if any remain).
2) Re-evaluate whether name-resolution outputs require a CROF-like durable evidence format.
3) Maintain conformance vectors and ensure `make regen-conformance && make test` stays green.
